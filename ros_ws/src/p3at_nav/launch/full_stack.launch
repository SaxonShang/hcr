<?xml version="1.0"?>
<launch>
  <!-- Full simulation stack:
       Gazebo + depth->scan + GMapping + map_manager + move_base + target follower.
  -->

  <arg name="use_rviz" default="true" />
  <arg name="use_moving_target" default="false" />
  <arg name="use_fake_target" default="true" />
  <arg name="use_yolo_candidates" default="false" />
  <arg name="use_mock_yolo" default="false" />

  <!-- Depth topic produced by p3at_sim's Gazebo depth camera plugin -->
  <!-- Use the true depth image (32FC1/16UC1). The image_rect_raw stream is often rgb8. -->
  <arg name="depth_topic" default="/sim_p3at/camera/depth/depth/image_raw" />

  <!-- If use_yolo_candidates=true, target_follower will select from /targets/candidates.
       Otherwise it will use map_manager's /dynamic_map/dynamic_pos.
  -->
  <arg name="real_target_topic" default="$(eval '/targets/selected_pos' if (arg('use_yolo_candidates') == 'true' or arg('use_mock_yolo') == 'true') else '/dynamic_map/dynamic_pos')" />

  <!-- 1) Gazebo simulation (includes the depth camera) -->
  <include file="$(find p3at_sim)/launch/bringup_depth.launch" />

  <!-- Optional: drive the red target_box in a circle -->
  <include file="$(find p3at_sim)/launch/move_target_box.launch" if="$(eval arg('use_moving_target') == 'true' or arg('use_mock_yolo') == 'true')" />

  <!-- 2) Depth image -> LaserScan (/scan) -->
  <include file="$(find p3at_nav)/launch/depth_to_scan.launch">
    <arg name="depth_image_topic" value="$(arg depth_topic)" />
  </include>

  <!-- 3) SLAM (GMapping) -->
  <include file="$(find p3at_nav)/launch/gmapping_slam.launch">
    <arg name="scan_topic" value="/scan" />
    <arg name="use_rviz" value="false" />
  </include>

  <!-- 4) Publish robot pose as PoseStamped in the map frame -->
  <include file="$(find p3at_nav)/launch/tf_to_pose.launch">
    <arg name="out_topic" value="/robot/pose" />
  </include>

  <!-- 5) map_manager: 3D voxel map + dynamic obstacle tracking -->
  <include file="$(find map_manager)/launch/dynamic_map.launch">
    <arg name="localization_mode" value="0" />
    <arg name="depth_topic" value="$(arg depth_topic)" />
    <arg name="pose_topic" value="/robot/pose" />
    <!-- odom_topic is ignored when localization_mode=0 -->
    <arg name="odom_topic" value="/sim_p3at/odom" />
  </include>

  <!-- 6) Navigation: move_base configured to use /map (from GMapping) and /scan + /dynamic_map/inflated_voxel_map -->
  <include file="$(find p3at_navigation)/launch/move_base_gmapping.launch" />

  <!-- 7) Target selection (optional): pick the easiest target from YOLO-style candidates.
       The selector subscribes to hcr_msgs/TargetCandidateArray on /targets/candidates and publishes /targets/selected_pos.
  -->
  <node pkg="target_follower" type="target_candidate_selector.py" name="target_candidate_selector" output="screen" if="$(eval arg('use_yolo_candidates') == 'true' or arg('use_mock_yolo') == 'true')">
    <param name="candidates_topic" value="/targets/candidates" />
    <param name="selected_topic" value="/targets/selected_pos" />
    <param name="map_frame" value="map" />
    <param name="base_frame" value="base_link" />
    <param name="min_confidence" value="0.05" />
  </node>

  <!-- 7b) Option B simulation: publish hcr_msgs/TargetCandidateArray from the Gazebo target_box model. -->
  <include file="$(find target_follower)/launch/mock_yolo_from_gazebo.launch" if="$(arg use_mock_yolo)">
    <arg name="model_name" value="target_box" />
    <arg name="frame_id" value="odom" />
    <arg name="candidates_topic" value="/targets/candidates" />
  </include>

  <!-- 8) Target follower.
       - If use_fake_target=true, target_pos_mux publishes /dynamic_map/target_pos and falls back to a slow fake target.
       - If use_fake_target=false, the follower listens directly to the real target topic.
  -->
  <node pkg="target_follower" type="target_pos_mux.py" name="target_pos_mux" output="screen" if="$(arg use_fake_target)">
    <param name="real_topic" value="$(arg real_target_topic)" />
    <param name="output_topic" value="/dynamic_map/target_pos" />
    <param name="map_frame" value="map" />
  </node>

  <node pkg="target_follower" type="follow_target.py" name="follow_target" output="screen">
    <param name="target_topic" value="$(eval '/dynamic_map/target_pos' if (arg('use_fake_target') == 'true') else arg('real_target_topic'))" />
  </node>

  <!-- 9) RViz -->
  <node pkg="rviz" type="rviz" name="rviz_full_stack"
        args="-d $(find p3at_nav)/rviz/hcr_integration.rviz"
        if="$(arg use_rviz)" />
</launch>
